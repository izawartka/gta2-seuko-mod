#include "invulnerability.h"
#include "../../../events/game-tick.h"
#include "../cheat-registry.h"

ModMenuModule::InvulnerabilityCheat::InvulnerabilityCheat(): ModMenuModule::CheatBase("Cheat_Invulnerability_IsEnabled") {
}

ModMenuModule::InvulnerabilityCheat::~InvulnerabilityCheat()
{
}

void ModMenuModule::InvulnerabilityCheat::OnFirstEnable()
{
	m_invulnerabilityResolver = Core::MakeResolver(
		Game::Memory::GetPlayerPed,
		mem(&Game::Ped::invulnerability)
	);
}

void ModMenuModule::InvulnerabilityCheat::OnEnable()
{
	m_watchedInvulnerability = Core::WatchManager::GetInstance()->Watch<GameTickEvent>(
		m_invulnerabilityResolver,
		this,
		&ModMenuModule::InvulnerabilityCheat::OnValueUpdate
	);
}

void ModMenuModule::InvulnerabilityCheat::OnDisable()
{
	if (m_invulnerabilityResolver == nullptr) return;

	Game::ushort* invulnerability = m_invulnerabilityResolver(); /// unsafe
	if (invulnerability) {
		*invulnerability = 0;
	}

	Core::WatchManager::GetInstance()->Unwatch(m_watchedInvulnerability);
	m_watchedInvulnerability = nullptr;
}

void ModMenuModule::InvulnerabilityCheat::OnValueUpdate(const std::optional<Game::ushort>& oldValue, const std::optional<Game::ushort>& newValue)
{
	if (!newValue.has_value()) return;
	m_watchedInvulnerability->SetValueNow(9999, false);
}

REGISTER_CHEAT(InvulnerabilityCheat)

#include "invulnerability.h"
#include "../../../events/game-tick.h"
#include "../cheat-registry.h"

ModMenuModule::InvulnerabilityCheat::InvulnerabilityCheat(): ModMenuModule::CheatBase("Cheat_Invulnerability_IsEnabled") {
}

ModMenuModule::InvulnerabilityCheat::~InvulnerabilityCheat()
{
}

void ModMenuModule::InvulnerabilityCheat::OnFirstEnable()
{
	m_invulnerabilityResolver = Core::MakeResolver(
		Game::Memory::GetCheats,
		mem(&Game::Cheats::invulnerability)
	);
}

void ModMenuModule::InvulnerabilityCheat::OnEnable()
{
	m_watchedInvulnerability = Core::WatchManager::GetInstance()->Watch<GameTickEvent, bool>(
		m_invulnerabilityResolver,
		this,
		&ModMenuModule::InvulnerabilityCheat::OnValueUpdate
	);
}

void ModMenuModule::InvulnerabilityCheat::OnDisable()
{
	m_watchedInvulnerability->SetValue(false);
	Core::WatchManager::GetInstance()->Unwatch<bool>(m_watchedInvulnerability);
	m_watchedInvulnerability = nullptr;
}

void ModMenuModule::InvulnerabilityCheat::OnValueUpdate(std::optional<bool> oldValue, std::optional<bool> newValue)
{
	if (!newValue.has_value() || newValue.value() == true) return;
	m_watchedInvulnerability->SetValue(IsEnabled());
}

REGISTER_CHEAT(InvulnerabilityCheat)
